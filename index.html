<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スタイリッシュ注文フォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* デザインに関するCSSは変更がないため省略します */
        :root {
            --color-primary-bg: #F8F9FA;
            --color-card-bg: #FFFFFF;
            --color-text-dark: #212529;
            --color-text-muted: #6C757D;
            --color-border-subtle: #DEE2E6;
            --color-corporate-green: #28A745;
            --color-corporate-green-light: #E9F8EE;
            --color-corporate-blue: #007BFF;
            --color-corporate-blue-light: #E0EFFE;
            --shadow-md-custom: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg-custom: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .bg-primary-bg { background-color: var(--color-primary-bg); }
        .bg-card-bg { background-color: var(--color-card-bg); }
        .text-text-dark { color: var(--color-text-dark); }
        .text-text-muted { color: var(--color-text-muted); }
        .border-border-subtle { border-color: var(--color-border-subtle); }
        .bg-corporate-green { background-color: var(--color-corporate-green); }
        .bg-corporate-green-light { background-color: var(--color-corporate-green-light); }
        .text-corporate-green { color: var(--color-corporate-green); }
        .bg-corporate-blue { background-color: var(--color-corporate-blue); }
        .bg-corporate-blue-light { background-color: var(--color-corporate-blue-light); }
        .text-corporate-blue { color: var(--color-corporate-blue); }
        .focus-ring-corporate-blue:focus {
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.4);
            border-color: var(--color-corporate-blue);
        }
        .shadow-md-custom { box-shadow: var(--shadow-md-custom); }
        .shadow-lg-custom { box-shadow: var(--shadow-lg-custom); }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css");
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-primary-bg min-h-screen flex items-center justify-center p-4">
    <div class="bg-card-bg rounded-3xl shadow-lg-custom p-6 md:p-10 w-full max-w-3xl">
        <h1 class="text-3xl md:text-4xl font-bold text-text-dark text-center mb-10">
            <i class="bi bi-box-seam inline-block align-middle text-corporate-green mr-3"></i> 注文受付フォーム
        </h1>

        <div class="bg-corporate-blue-light rounded-xl p-5 mb-8 shadow-md-custom text-base md:text-lg border border-corporate-blue">
            <p class="text-text-dark mb-2 flex items-center">
                <i class="bi bi-person-fill text-corporate-blue mr-3 text-xl"></i>
                <span class="font-semibold">ユーザーID:</span> <span id="userIdDisplay" class="ml-2 font-medium text-text-muted">読み込み中...</span>
            </p>
            <p class="text-text-dark mb-2 flex items-center">
                <i class="bi bi-file-person-fill text-corporate-blue mr-3 text-xl"></i>
                <span class="font-semibold">ユーザー名:</span> <span id="userNameDisplay" class="ml-2 font-medium text-text-muted">読み込み中...</span>
            </p>
        </div>

        <form id="orderForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="companyName" class="block text-text-dark text-sm font-semibold mb-2 required"><i class="bi bi-building text-corporate-green mr-2"></i>会社名</label>
                    <input type="text" id="companyName" required class="w-full p-3.5 rounded-lg bg-gray-50 border border-border-subtle focus:outline-none focus:ring-2 focus:ring-corporate-blue focus-ring-corporate-blue">
                </div>
                <div>
                    <label for="fullName" class="block text-text-dark text-sm font-semibold mb-2 required"><i class="bi bi-person-badge text-corporate-green mr-2"></i>氏名</label>
                    <input type="text" id="fullName" required class="w-full p-3.5 rounded-lg bg-gray-50 border border-border-subtle focus:outline-none focus:ring-2 focus:ring-corporate-blue focus-ring-corporate-blue">
                </div>
            </div>
            <button type="submit" id="submitOrder" class="bg-corporate-green text-white p-4 rounded-xl font-bold text-xl w-full hover:bg-green-700 transition duration-300 flex items-center justify-center">
                <i class="bi bi-send-fill mr-3"></i> 注文を送信する
            </button>
            <p id="statusMessage" class="mt-4 text-center text-base font-medium text-text-dark"></p>
        </form>
        <p id="versionInfo" class="mt-8 text-text-muted text-xs text-center"></p>
    </div>

    <script>
        // ★最重要★: この値がGitHub Actions等で正しく置き換えられているか確認してください
        const cloudFunctionUrl = '{{SECRET_KEY}}'; 
        const liffId = '{{SECRET_KEY2}}';

        // HTML要素の取得 (変更なし)
        const userIdDisplay = document.getElementById('userIdDisplay');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const statusMessage = document.getElementById('statusMessage');
        // ... 他の要素 ...

        // 変数定義
        let currentUserId = '未取得';
        let currentUserName = '未取得';
        let currentChatRoomId = '未取得';
        let accessNotified = false; // ★修正点2: アクセス通知用のフラグを復活★
        const uploadedFiles = [];

        // ファイルアップロード関連のロジック (変更なしのため省略)

        // Cloud Functionsへの送信関数 (変更なしのため省略)
        async function sendToCloudFunction(action, data) { /* ... */ }

        // LIFF初期化処理
        if (typeof liff === 'undefined') {
            console.error("エラー: LIFF SDKが読み込まれていません。");
            userIdDisplay.innerText = 'エラー: SDK読み込み失敗';
            userNameDisplay.innerText = 'エラー: SDK読み込み失敗';
        } else {
            liff.init({ liffId: liffId })
                .then(async () => {
                    console.log("LIFF initialization successful!");
                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        currentUserId = profile.userId;
                        currentUserName = profile.displayName;
                        userIdDisplay.innerText = currentUserId;
                        userNameDisplay.innerText = currentUserName;
                        console.log('User Profile:', profile);
                        
                        // ★修正点2: 正常版にあったアクセス通知処理を復活★
                        if (!accessNotified && currentUserId !== '未取得') {
                            try {
                                // この'notify_access'はCloud Functions側の実装に依存します
                                await sendToCloudFunction('notify_access', { userId: currentUserId });
                                console.log('Access notification sent successfully.');
                                accessNotified = true;
                            } catch (notifyError) {
                                console.error('Error sending access notification:', notifyError);
                            }
                        }

                        // ★正常版にあった自動入力処理★
                        if (currentUserId !== '未取得') {
                            try {
                                const result = await sendToCloudFunction('get_user_profile', { userId: currentUserId });
                                if (result.success && result.data) {
                                    // フォームに値をセット
                                    document.getElementById('companyName').value = result.data.companyName || '';
                                    document.getElementById('fullName').value = result.data.fullName || '';
                                    // ... 他のフィールド ...
                                    statusMessage.innerText = '前回の情報が自動入力されました。';
                                } else {
                                    statusMessage.innerText = '初回利用、または既存の情報が見つかりませんでした。';
                                }
                            } catch (profileError) {
                                console.error('Error getting user profile for autofill:', profileError);
                                statusMessage.innerText = `情報取得中にエラーが発生しました。`;
                            }
                        }
                    } else {
                        liff.login();
                    }
                })
                .catch((err) => {
                    console.error("LIFF初期化に失敗しました: ", err);
                    // ★修正点3: エラーメッセージをより具体的に変更★
                    userIdDisplay.innerText = '初期化エラー';
                    userNameDisplay.innerText = '初期化エラー';
                    statusMessage.innerText = 'LIFFの初期化に失敗しました。LIFF IDが正しいか確認してください。';
                    statusMessage.classList.add('text-red-500');
                });
        }
        
        // フォーム送信処理 (変更なしのため省略)
        document.getElementById('orderForm').addEventListener('submit', async (e) => { /* ... */ });
    </script>
</body>
</html>
