<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LINE情報記録アプリ</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .info-section p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        #userIdDisplay, #userNameDisplay, #chatRoomIdDisplay { 
            font-weight: bold;
            color: #007bff;
        }
        .loading {
            color: #888;
        }
        button#submitData {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            width: 100%;
        }
        button#submitData:hover {
            background-color: #218838;
        }
        #statusMessage {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }
        .error {
            color: red;
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>LINE情報記録</h1>
        <div class="info-section">
            <p>ユーザーID: <span id="userIdDisplay" class="loading">読み込み中...</span></p>
            <p>ユーザー名: <span id="userNameDisplay" class="loading">読み込み中...</span></p>
            <p>トークルームID: <span id="chatRoomIdDisplay" class="loading">読み込み中...</span></p>
        </div>
        
        <button id="submitData">スプレッドシートに記録する</button>
        <p id="statusMessage"></p>
    </div>

    <script>
        // ★重要: ここにLINE Developersで取得したあなたのLIFF IDを設定してください★
        const liffId = '2007576580-4q0azmME'; // 例: '2007576580-4q0azmME'; 

        // ★重要: ここにGASでデプロイしたウェブアプリのURLを設定してください★
        const gasWebhookUrl = 'https://script.google.com/macros/s/AKfycbytrnkr4l95vvZv5_kXLmw8I05Uv_YusAL5MffkZplVEdETQ3x39vpfmwmOkJPxAjkC/exec'; // 例: 'https://script.google.com/macros/s/AKfycbxR76bPIJfXQppnhqAVBWYPZFU_uvnUdQ917O53a3_ASCcvoFSH8HtnXYgXFyykLaJa/exec';

        const statusMessage = document.getElementById('statusMessage');
        let currentUserId = '未取得'; 
        let currentUserName = '未取得';
        let currentChatRoomId = '未取得';

        // アクセス通知を一度だけ送信するためのフラグ
        let accessNotified = false; 

        // GASへのPOSTリクエスト送信ヘルパー関数
        async function sendToGas(action, data) {
            try {
                const postData = { action: action, ...data }; // actionフィールドを追加
                console.log(`Sending ${action} data to GAS:`, postData);

                const response = await fetch(gasWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(postData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error Status:', response.status);
                    console.error('HTTP Error Text:', errorText);
                    throw new Error(`GASからのHTTPエラー: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log(`GAS response for ${action}:`, result);
                return result;

            } catch (error) {
                console.error(`Error in sendToGas (${action}):`, error);
                // エラーメッセージをHTML表示するため、ここでthrowする
                throw error; 
            }
        }


        // LIFF初期化処理
        if (typeof liff === 'undefined') {
            console.error("エラー: LIFF SDKが読み込まれていません。スクリプトタグを確認してください。");
            document.getElementById('userIdDisplay').innerText = 'エラー: SDK読み込み失敗';
            document.getElementById('userNameDisplay').innerText = 'エラー: SDK読み込み失敗';
            document.getElementById('chatRoomIdDisplay').innerText = 'コンソールを確認してください。';
        } else {
            liff.init({ liffId: liffId })
            .then(async () => { // asyncを追加
                console.log("LIFF initialization successful!");
                document.getElementById('userIdDisplay').classList.remove('loading');
                document.getElementById('userNameDisplay').classList.remove('loading');
                document.getElementById('chatRoomIdDisplay').classList.remove('loading');

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile(); // awaitを追加
                    currentUserId = profile.userId; 
                    currentUserName = profile.displayName;
                    document.getElementById('userIdDisplay').innerText = currentUserId;
                    document.getElementById('userNameDisplay').innerText = currentUserName;
                    console.log('User Profile:', profile);

                    const context = liff.getContext();
                    if (context) {
                        if (context.type === 'chat' || context.type === 'room') {
                            currentChatRoomId = context.chatId;
                        } else {
                            currentChatRoomId = `（${context.type}から開かれました）`;
                        }
                        document.getElementById('chatRoomIdDisplay').innerText = currentChatRoomId;
                        console.log('LIFF Context:', context);
                    } else {
                        currentChatRoomId = '（LIFFコンテキストが取得できません）';
                        document.getElementById('chatRoomIdDisplay').innerText = currentChatRoomId;
                        console.warn('LIFF context is null.');
                    }

                    // ★LIFFにログインし、ユーザーIDが取得できたらアクセス通知を送信★
                    if (!accessNotified && currentUserId !== '未取得') {
                        try {
                            const result = await sendToGas('notify_access', { userId: currentUserId });
                            if (result.success) {
                                console.log('Access notification sent successfully.');
                                accessNotified = true; // 送信済みフラグを立てる
                            } else {
                                console.error('Failed to send access notification:', result.message);
                                // HTML上にエラーを表示しないが、コンソールにはログを残す
                            }
                        } catch (notifyError) {
                            console.error('Error sending access notification:', notifyError);
                            // HTML上にエラーを表示しないが、コンソールにはログを残す
                        }
                    }

                } else {
                    liff.login(); 
                }
            })
            .catch((err) => {
                console.error("LIFF初期化に失敗しました: ", err);
                document.getElementById('userIdDisplay').innerText = '初期化エラー';
                document.getElementById('userNameDisplay').innerText = '初期化エラー';
                document.getElementById('chatRoomIdDisplay').innerText = '（詳細はコンソールを確認）';
            });
        }

        // スプレッドシート記録ボタンの処理
        document.getElementById('submitData').addEventListener('click', async () => {
            statusMessage.innerText = '';
            statusMessage.classList.remove('error');

            if (!liff.isLoggedIn()) {
                statusMessage.innerText = 'LIFFにログインしていません。ログイン後に再度お試しください。';
                statusMessage.classList.add('error');
                liff.login();
                return;
            }
            
            if (currentUserId === '未取得' || currentUserName === '未取得' || currentChatRoomId === '未取得') {
                statusMessage.innerText = 'ユーザー情報がまだ取得できていません。少し待ってから再度お試しください。';
                statusMessage.classList.add('error');
                return;
            }

            statusMessage.innerText = 'データを送信中...';
            statusMessage.style.color = 'orange';
            document.getElementById('submitData').disabled = true; // 送信ボタンを無効化

            try {
                const result = await sendToGas('record_data', {
                    userId: currentUserId,
                    userName: currentUserName,
                    chatRoomId: currentChatRoomId
                });

                if (result.success) {
                    statusMessage.innerText = 'データがスプレッドシートに正常に記録されました！';
                    statusMessage.style.color = 'green';
                    // スプレッドシート記録成功後にLIFFアプリを閉じる（任意）
                    // setTimeout(() => { liff.closeWindow(); }, 2000); 
                } else {
                    statusMessage.innerText = `データ記録に失敗しました: ${result.message || '不明なエラー'}`;
                    statusMessage.classList.add('error');
                    console.error('Failed to record data (GAS response):', result.error);
                }
            } catch (error) {
                statusMessage.innerText = `データ送信中にエラーが発生しました: ${error.message}`;
                statusMessage.classList.add('error');
                console.error('Error submitting data:', error);
                if (error.message.includes('Failed to fetch')) {
                    statusMessage.innerText += '\n(ヒント: GASのURLが正しいか、GASのデプロイとCORS設定を確認してください)';
                }
            } finally {
                document.getElementById('submitData').disabled = false; 
            }
        });
    </script>
</body>
</html>
