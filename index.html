<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LINE情報記録アプリ</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .info-section p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        #userName, #chatRoomId {
            font-weight: bold;
            color: #007bff;
        }
        .loading {
            color: #888;
        }
        button#submitData {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            width: 100%;
        }
        button#submitData:hover {
            background-color: #218838;
        }
        #statusMessage {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }
        .error {
            color: red;
        }
    </style>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <div class="container">
        <h1>LINE情報記録</h1>
        <div class="info-section">
            <p>ユーザー名: <span id="userName" class="loading">読み込み中...</span></p>
            <p>トークルームID: <span id="chatRoomId" class="loading">読み込み中...</span></p>
        </div>
        
        <button id="submitData">スプレッドシートに記録する</button>
        <p id="statusMessage"></p>
    </div>

    <script>
        // ★重要: ここにLINE Developersで取得したあなたのLIFF IDを設定してください★
        const liffId = '2007576580-4q0azmME'; 

        // ★重要: ここにGASでデプロイしたウェブアプリのURLを設定してください★
        const gasWebhookUrl = 'https://script.google.com/macros/s/AKfycbxOFXwA5whfR7qYhxnEzkmr4zR7CfyrcBqxm6L-ucu_1TlvCWV41hTyFyuCi7z4zp-7/exec'; 

        const statusMessage = document.getElementById('statusMessage');
        let currentUserName = '未取得';
        let currentChatRoomId = '未取得';

        // LIFF初期化処理
        if (typeof liff === 'undefined') {
            console.error("エラー: LIFF SDKが読み込まれていません。スクリプトタグを確認してください。");
            document.getElementById('userName').innerText = 'エラー: LIFF SDKが読み込めません。';
            document.getElementById('chatRoomId').innerText = 'コンソールを確認してください。';
        } else {
            liff.init({ liffId: liffId })
            .then(() => {
                console.log("LIFF initialization successful!");
                document.getElementById('userName').classList.remove('loading');
                document.getElementById('chatRoomId').classList.remove('loading');

                if (liff.isLoggedIn()) {
                    liff.getProfile().then(profile => {
                        currentUserName = profile.displayName;
                        document.getElementById('userName').innerText = currentUserName;
                        console.log('User Profile:', profile);
                    }).catch(err => {
                        console.error("Error getting profile: ", err);
                        document.getElementById('userName').innerText = 'ユーザー名取得エラー';
                    });

                    const context = liff.getContext();
                    if (context) {
                        if (context.type === 'chat' || context.type === 'room') {
                            currentChatRoomId = context.chatId;
                            document.getElementById('chatRoomId').innerText = currentChatRoomId;
                        } else {
                            currentChatRoomId = `（チャット/グループ以外から開かれました: ${context.type}）`;
                            document.getElementById('chatRoomId').innerText = currentChatRoomId;
                        }
                    } else {
                        document.getElementById('chatRoomId').innerText = '（LIFFコンテキストが取得できません）';
                    }
                } else {
                    liff.login(); 
                }
            })
            .catch((err) => {
                console.error("LIFF初期化に失敗しました: ", err);
                document.getElementById('userName').innerText = 'LIFF初期化エラー';
                document.getElementById('chatRoomId').innerText = '（詳細はコンソールを確認）';
            });
        }

        // データ送信処理
        document.getElementById('submitData').addEventListener('click', async () => {
            statusMessage.innerText = '';
            statusMessage.classList.remove('error');

            if (!liff.isLoggedIn()) {
                statusMessage.innerText = 'LIFFにログインしていません。ログイン後に再度お試しください。';
                statusMessage.classList.add('error');
                liff.login();
                return;
            }
            
            if (currentUserName === '未取得' || currentChatRoomId === '未取得') {
                statusMessage.innerText = 'ユーザー情報がまだ取得できていません。少し待ってから再度お試しください。';
                statusMessage.classList.add('error');
                return;
            }

            statusMessage.innerText = 'データを送信中...';
            statusMessage.style.color = 'orange';
            document.getElementById('submitData').disabled = true; // 送信ボタンを無効化

            try {
                const postData = {
                    userName: currentUserName,
                    chatRoomId: currentChatRoomId
                };

                console.log("Sending data to GAS:", postData); // 送信データをコンソールにログ出力

                const response = await fetch(gasWebhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });
                
                // レスポンスのHTTPステータスコードをチェック
                if (!response.ok) {
                    const errorText = await response.text(); // テキストとしてエラー内容を取得
                    console.error('HTTP Error Status:', response.status);
                    console.error('HTTP Error Text:', errorText);
                    throw new Error(`GASからのHTTPエラー: ${response.status} - ${errorText}`);
                }

                const result = await response.json(); // JSONとして解析

                if (result.success) {
                    statusMessage.innerText = 'データがスプレッドシートに正常に記録されました！';
                    statusMessage.style.color = 'green';
                    setTimeout(() => {
                        liff.closeWindow(); // 成功後、LIFFアプリを閉じる
                    }, 2000); // 2秒後に閉じる
                } else {
                    // GASから返されたエラーメッセージを表示
                    statusMessage.innerText = `データ記録に失敗しました: ${result.message || '不明なエラー'}`;
                    statusMessage.classList.add('error');
                    console.error('Failed to record data (GAS response):', result.error);
                }
            } catch (error) {
                // 'Failed to fetch' やその他のネットワークエラーをここで捕捉
                statusMessage.innerText = `データ送信中にエラーが発生しました: ${error.message}`;
                statusMessage.classList.add('error');
                console.error('Error submitting data:', error);
                // ネットワークエラーの場合、URLが間違っていないか、CORS設定は正しいか確認を促す
                if (error.message.includes('Failed to fetch')) {
                    statusMessage.innerText += '\n(ヒント: GASのURLが正しいか、GASのデプロイとCORS設定を確認してください)';
                }
            } finally {
                document.getElementById('submitData').disabled = false; // 送信ボタンを再度有効化
            }
        });
    </script>
</body>
</html>
